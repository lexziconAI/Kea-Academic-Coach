<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kea Admin Dashboard</title>
    <style>
        :root {
            --kea-green: #4CAF50;
            --kea-dark: #1a1a2e;
            --kea-light: #16213e;
            --kea-accent: #e94560;
            --kea-gold: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--kea-dark) 0%, var(--kea-light) 100%);
            min-height: 100vh;
            color: white;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .login-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--kea-green);
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(145deg, var(--kea-green), #45a049);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .login-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }
        
        .login-error {
            color: var(--kea-accent);
            text-align: center;
            margin-top: 15px;
            display: none;
        }
        
        /* Dashboard */
        .dashboard {
            display: none;
            padding: 20px;
        }
        
        .dashboard.active {
            display: block;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .dashboard-title {
            font-size: 1.5em;
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--kea-accent);
            border-radius: 8px;
            color: var(--kea-accent);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: var(--kea-accent);
            color: white;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--kea-green);
        }
        
        .stat-card .label {
            color: #888;
            margin-top: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-btn:hover, .tab-btn.active {
            background: rgba(76, 175, 80, 0.2);
            border-color: var(--kea-green);
            color: white;
        }
        
        /* Tables */
        .data-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            color: var(--kea-green);
            font-weight: 600;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .data-table tr.archived-row {
            opacity: 0.6;
            background: rgba(155, 89, 182, 0.05);
        }
        
        .data-table tr.archived-row:hover {
            opacity: 0.8;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-active { background: rgba(76, 175, 80, 0.2); color: var(--kea-green); }
        .status-completed { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .status-timeout { background: rgba(243, 156, 18, 0.2); color: var(--kea-gold); }
        .status-abandoned { background: rgba(233, 69, 96, 0.2); color: var(--kea-accent); }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85em;
            margin-right: 5px;
            transition: all 0.2s;
        }
        
        .action-btn.view {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .action-btn.export {
            background: rgba(76, 175, 80, 0.2);
            color: var(--kea-green);
        }
        
        .action-btn.delete {
            background: rgba(233, 69, 96, 0.2);
            color: var(--kea-accent);
        }
        
        .action-btn.archive {
            background: rgba(243, 156, 18, 0.2);
            color: var(--kea-gold);
        }
        
        .action-btn.unarchive {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--kea-dark);
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--kea-dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .session-detail {
            margin-bottom: 20px;
        }
        
        .session-detail h3 {
            color: var(--kea-green);
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .session-detail pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .conversation-turn {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
        }
        
        .conversation-turn.user {
            border-left: 3px solid var(--kea-green);
        }
        
        .conversation-turn.assistant {
            border-left: 3px solid #3498db;
        }
        
        .turn-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
            color: #888;
        }
        
        .turn-role {
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .turn-role.user { color: var(--kea-green); }
        .turn-role.assistant { color: #3498db; }
        
        /* Search */
        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--kea-green);
        }
        
        .refresh-btn {
            padding: 12px 24px;
            background: var(--kea-green);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: #45a049;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="login-screen">
        <div class="login-panel">
            <div class="login-title">üîê Admin Access</div>
            <div class="login-subtitle">Kea Academic Coach Dashboard</div>
            
            <div class="form-group">
                <label>Admin ID</label>
                <input type="text" id="admin-id" placeholder="Enter admin ID">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="admin-pass" placeholder="Enter password">
            </div>
            
            <button class="login-btn" onclick="attemptLogin()">Sign In</button>
            
            <div class="login-error" id="login-error">Invalid credentials</div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <div class="dashboard-title">üìä Kea Admin Dashboard</div>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="number" id="stat-users">-</div>
                <div class="label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-sessions">-</div>
                <div class="label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-active">-</div>
                <div class="label">Active Sessions</div>
            </div>
            <div class="stat-card">
                <div class="number" id="stat-turns">-</div>
                <div class="label">Total Turns</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('sessions')">üìã Sessions</button>
            <button class="tab-btn" onclick="showTab('users')">üë• Users</button>
            <button class="tab-btn" onclick="showTab('reports')">üìÑ Reports</button>
        </div>
        
        <!-- Search -->
        <div class="search-bar">
            <input type="text" class="search-input" id="search-input" placeholder="Search by name, email, or organisation...">
            <label style="display: flex; align-items: center; gap: 8px; color: #888; cursor: pointer;">
                <input type="checkbox" id="show-archived" onchange="toggleArchived()" style="width: 18px; height: 18px;">
                <span>Show Archived</span>
            </label>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
        </div>
        
        <!-- Data Panels -->
        <div class="data-panel" id="sessions-panel">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>User</th>
                        <th>Organisation</th>
                        <th>Started</th>
                        <th>Status</th>
                        <th>Turns</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                    <!-- Data loaded dynamically -->
                </tbody>
            </table>
        </div>
        
        <div class="data-panel" id="users-panel" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Registered</th>
                        <th>Sessions</th>
                        <th>Last Active</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    <!-- Data loaded dynamically -->
                </tbody>
            </table>
        </div>
        
        <div class="data-panel" id="reports-panel" style="display: none;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Report ID</th>
                        <th>Session</th>
                        <th>Generated</th>
                        <th>Hash</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-tbody">
                    <!-- Data loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Session Detail Modal -->
    <div class="modal-overlay" id="session-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Session Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
    
    <script>
        // Auth state
        let isAuthenticated = false;
        const ADMIN_ID = 'Admin';
        const ADMIN_PASS = 'IamallinonAI';
        
        // Check for existing session
        if (sessionStorage.getItem('kea_admin_auth') === 'true') {
            isAuthenticated = true;
            showDashboard();
        }
        
        function attemptLogin() {
            const id = document.getElementById('admin-id').value;
            const pass = document.getElementById('admin-pass').value;
            
            // Case-insensitive username check
            if (id.toLowerCase() === ADMIN_ID.toLowerCase() && pass === ADMIN_PASS) {
                isAuthenticated = true;
                sessionStorage.setItem('kea_admin_auth', 'true');
                showDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }
        
        function logout() {
            isAuthenticated = false;
            sessionStorage.removeItem('kea_admin_auth');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }
        
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            loadData();
        }
        
        function showTab(tab) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show panel
            document.getElementById('sessions-panel').style.display = tab === 'sessions' ? 'block' : 'none';
            document.getElementById('users-panel').style.display = tab === 'users' ? 'block' : 'none';
            document.getElementById('reports-panel').style.display = tab === 'reports' ? 'block' : 'none';
        }
        
        async function loadData() {
            // Show loading state
            document.getElementById('stat-users').textContent = '...';
            document.getElementById('stat-sessions').textContent = '...';
            document.getElementById('stat-active').textContent = '...';
            document.getElementById('stat-turns').textContent = '...';
            
            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: { 'X-Admin-Auth': 'true' }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown server error');
                }
                
                // Store all sessions for filtering
                allSessions = data.sessions || [];
                
                // If showing archived, also fetch archived sessions
                let sessionsToShow = allSessions;
                if (showArchived) {
                    try {
                        const archivedResponse = await fetch('/api/admin/sessions/archived');
                        const archivedData = await archivedResponse.json();
                        if (archivedData.success && archivedData.sessions) {
                            // Combine active and archived sessions
                            sessionsToShow = [...allSessions, ...archivedData.sessions];
                        }
                    } catch (err) {
                        console.error('Failed to load archived sessions:', err);
                    }
                }
                
                // Update stats (only count non-archived)
                document.getElementById('stat-users').textContent = data.stats?.totalUsers ?? 0;
                document.getElementById('stat-sessions').textContent = data.stats?.totalSessions ?? 0;
                document.getElementById('stat-active').textContent = data.stats?.activeSessions ?? 0;
                document.getElementById('stat-turns').textContent = data.stats?.totalTurns ?? 0;
                
                // Render sessions (with or without archived)
                renderSessions(sessionsToShow);
                
                // Render users
                renderUsers(data.users || []);
                
                // Render reports
                renderReports(data.reports || []);
                
            } catch (err) {
                console.error('Failed to load data:', err);
                // Show error to user
                document.getElementById('stat-users').textContent = '‚ùå';
                document.getElementById('stat-sessions').textContent = '‚ùå';
                document.getElementById('stat-active').textContent = '‚ùå';
                document.getElementById('stat-turns').textContent = '‚ùå';
                
                // Show error message in sessions panel
                const tbody = document.getElementById('sessions-tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state" style="color: var(--kea-accent);">
                                <div class="icon">‚ö†Ô∏è</div>
                                <div>Failed to load data</div>
                                <div style="font-size: 0.85em; margin-top: 10px; color: #888;">${err.message}</div>
                                <button class="refresh-btn" style="margin-top: 15px;" onclick="loadData()">üîÑ Retry</button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderSessions(sessions) {
            const tbody = document.getElementById('sessions-tbody');
            
            if (!sessions || sessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="icon">üì≠</div>
                                <div>No sessions yet</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = sessions.map(s => `
                <tr class="${s.archived ? 'archived-row' : ''}">
                    <td><code>${s.session_id?.substring(0, 20)}...</code></td>
                    <td>${s.user_name || 'Anonymous'}</td>
                    <td>${s.organisation_name || '-'}</td>
                    <td>${formatDate(s.started_at)}</td>
                    <td>
                        <span class="status-badge status-${s.status}">${s.status}</span>
                        ${s.archived ? '<span class="status-badge" style="background: rgba(155,89,182,0.2); color: #9b59b6; margin-left: 5px;">üì¶ Archived</span>' : ''}
                    </td>
                    <td>${s.turn_count || 0}</td>
                    <td>
                        <button class="action-btn view" onclick="viewSession('${s.session_id}')">üëÅÔ∏è View</button>
                        <button class="action-btn export" onclick="exportSession('${s.session_id}')">üì• Export</button>
                        ${s.archived 
                            ? `<button class="action-btn unarchive" onclick="unarchiveSession('${s.session_id}')">üì§ Restore</button>`
                            : `<button class="action-btn archive" onclick="archiveSession('${s.session_id}')">üì¶ Archive</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('users-tbody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="icon">üë§</div>
                                <div>No users yet</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${formatDate(u.created_at)}</td>
                    <td>${u.session_count || 0}</td>
                    <td>${formatDate(u.last_session_at) || '-'}</td>
                    <td>
                        <button class="action-btn view" onclick="viewUserSessions(${u.id})">üìã Sessions</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function renderReports(reports) {
            const tbody = document.getElementById('reports-tbody');
            
            if (!reports || reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="icon">üìÑ</div>
                                <div>No reports generated yet</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = reports.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td><code>${r.session_id?.substring(0, 20)}...</code></td>
                    <td>${formatDate(r.generated_at)}</td>
                    <td><code>${r.report_hash?.substring(0, 16)}...</code></td>
                    <td>
                        <button class="action-btn export" onclick="downloadReport(${r.id})">üì• Download</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function viewSession(sessionId) {
            try {
                const response = await fetch(`/api/admin/session/${sessionId}`);
                const data = await response.json();
                
                document.getElementById('modal-title').textContent = `Session: ${sessionId.substring(0, 25)}...`;
                
                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = `
                    <div class="session-detail">
                        <h3>üìã Session Info</h3>
                        <pre>${JSON.stringify({
                            status: data.session?.status,
                            started: data.session?.started_at,
                            ended: data.session?.ended_at,
                            responseLength: data.session?.response_length,
                            organisation: data.session?.organisation_name,
                            wordCount: data.session?.document_word_count
                        }, null, 2)}</pre>
                    </div>
                    
                    <div class="session-detail">
                        <h3>üí¨ Conversation (${data.turns?.length || 0} turns)</h3>
                        <div id="conversation-container">
                            ${(data.turns || []).map(t => `
                                <div class="conversation-turn ${t.role}">
                                    <div class="turn-header">
                                        <span class="turn-role ${t.role}">${t.role}</span>
                                        <span>${formatDate(t.timestamp)}</span>
                                    </div>
                                    <div class="turn-content">${escapeHtml(t.content)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${data.session?.key_takeaways_html ? `
                        <div class="session-detail">
                            <h3>üìù Key Takeaways</h3>
                            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                                ${data.session.key_takeaways_html}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.session?.initial_parse_json ? `
                        <div class="session-detail">
                            <h3>üîç Initial Analysis (JSON)</h3>
                            <pre>${JSON.stringify(JSON.parse(data.session.initial_parse_json), null, 2)}</pre>
                        </div>
                    ` : ''}
                `;
                
                document.getElementById('session-modal').classList.add('active');
                
            } catch (err) {
                console.error('Failed to load session:', err);
                alert('Failed to load session details');
            }
        }
        
        async function exportSession(sessionId) {
            try {
                const response = await fetch(`/api/session-report?sessionId=${sessionId}`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `kea_session_${sessionId.substring(0, 15)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export session');
                }
            } catch (err) {
                console.error('Export failed:', err);
                alert('Export failed');
            }
        }
        
        async function downloadReport(reportId) {
            try {
                const response = await fetch(`/api/admin/report/${reportId}`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `kea_report_${reportId}_${data.report_hash.substring(0, 8)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download report');
                }
            } catch (err) {
                console.error('Download failed:', err);
                alert('Download failed');
            }
        }
        
        function closeModal() {
            document.getElementById('session-modal').classList.remove('active');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Search functionality
        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.data-table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });
        
        // Archive state
        let showArchived = false;
        let allSessions = [];
        
        function toggleArchived() {
            showArchived = document.getElementById('show-archived').checked;
            loadData();
        }
        
        async function archiveSession(sessionId) {
            if (!confirm('Archive this session? It will be hidden from the main view but data will be preserved.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/session/archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadData(); // Refresh the list
                } else {
                    alert('Failed to archive session: ' + data.error);
                }
            } catch (err) {
                console.error('Archive failed:', err);
                alert('Failed to archive session');
            }
        }
        
        async function unarchiveSession(sessionId) {
            try {
                const response = await fetch('/api/admin/session/unarchive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadData(); // Refresh the list
                } else {
                    alert('Failed to restore session: ' + data.error);
                }
            } catch (err) {
                console.error('Unarchive failed:', err);
                alert('Failed to restore session');
            }
        }
        
        // Enter to login
        document.getElementById('admin-pass').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });
    </script>
</body>
</html>
